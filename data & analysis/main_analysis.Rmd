---
title: "Interruptions Judgment Analysis"
output:
---
```{r pre-setup}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```


```{r setup}
#load packages
library("tidyverse") # for all things tidyverse
library("dplyr")
library("pwr")
library("lme4")
library("brms")
library("lmerTest")
library("ggplot2")
library("bootstrap")
library("tm")

#environment-level changes
theme_classic()

#Helper scripts
dodge = position_dodge(.9)
theta <- function(x, xdata, na.rm=T) {
  mean(xdata[x],
       na.rm = na.rm)
  }
ci.low <- function(x,na.rm=T) {
  mean(x, na.rm = na.rm) - 
    quantile(
      bootstrap(
        1:length(x),
        1000,
        theta,
        x,
        na.rm = na.rm)$thetastar,
      .025,
      na.rm = na.rm)
  }
ci.high <- function(x,na.rm=T) {
  quantile(
    bootstrap(
      1:length(x),
      1000,
      theta,
      x,
      na.rm = na.rm)$thetastar,
    .975,
    na.rm = na.rm) - mean(x, na.rm = na.rm)
  }
```

```{r sanity checks}
# number of participants, should equal 650
length(unique(read.csv("int-judgment/data/int-judgment/int-judgment-workerids.csv",
              header = TRUE)$workerid))
# mean completion time, should be around 6 mins
# mean(read.csv("int-judgment/data/int-judgment/int-judgment-time_in_minutes.csv",
mean(read.csv("int-judgment/data/int-main-pilot/int-main-pilot-time_in_minutes.csv",
              header = TRUE)$time_in_minutes)
```


```{r data reading & wrangling}
# df <- read_csv("int-judgment/data/int-judgment/int-judgment-trials.csv") %>%
df <- read_csv("int-judgment/data/int-main-pilot/int-main-pilot-trials.csv") %>%
  # remove non-relevant columns
  select( -c(proliferate.condition,
             error))
df <- df %>% 
  mutate(PEM_interruptor = (A_friendly + A_agree + A_engaged) / 3,
         PEM_interruptee = (B_friendly + B_agree + B_engaged) / 3,
         IM = ((100 - B_listened) + B_feel_int + A_try_int) / 3,
         A_face = sub('stims\\/face_stims\\/[wb][mf]faces\\/',
                       '', A_face),
         B_face = sub('stims\\/face_stims\\/[wb][mf]faces\\/',
                       '', B_face)
         ) %>% 
  unite("int_race_gender", int_race, int_sex, sep = " ", remove = FALSE)

##subject information data
# subinfo <- read_csv("int-judgment/data/int-judgment/int-judgment-subjet_information.csv",
subinfo <- read_csv("int-judgment/data/int-main-pilot/int-main-pilot-subjet_information.csv")
```


```{r basic visualizations}
# some data wrangling to do first
# only looking at PEM and IM now
df_pared <- df %>% 
  select(c(int_race_gender, int_race, int_sex, A_face, speaker_A, interruption_style, PEM_interruptor, IM))

df_pared_long <- df_pared %>% 
    pivot_longer(c(PEM_interruptor, IM),
                 names_to = "metric",
                 values_to = "response")

df_pared_summary <- df_pared %>% 
  group_by(int_race_gender, interruption_style) %>% 
  summarize(PEM_avg = mean(PEM_interruptor),
            PEM_CILow = ci.low(PEM_interruptor),
            PEM_CIHigh = ci.high(PEM_interruptor),
            IM_avg = mean(IM),
            IM_CILow = ci.low(IM),
            IM_CIHigh = ci.high(IM)) %>% 
  ungroup() %>% 
  mutate(PEM_min = PEM_avg - PEM_CILow,
         PEM_max = PEM_avg + PEM_CIHigh,
         IM_min = IM_avg - IM_CILow,
         IM_max = IM_avg + IM_CIHigh) %>% 
  select(-c(PEM_CILow,
            PEM_CIHigh,
            IM_CILow,
            IM_CIHigh)) %>% 
  pivot_longer(c(PEM_avg,
                 IM_avg),
               names_to = "metric",
               values_to = "response") %>% 
  mutate(lower_bound = if_else(metric == "PEM_avg",
                               PEM_min,
                               IM_min),
         upper_bound = if_else(metric == "PEM_avg",
                               PEM_max,
                               IM_max),
         metric = recode(as.factor(metric),
                         "PEM_avg" = "PEM",
                         "IM_avg" = "IM")) %>% 
  select(-c(PEM_max, PEM_min, IM_max, IM_min))
  



summary_plot <- df_pared_long %>% 
  ggplot(aes(x = metric,
         y = response,
         fill = int_race_gender)) +
  facet_wrap(~ interruption_style) +
  geom_bar(stat = "identity", position = "dodge")
summary_plot

error_bars_plot <- df_pared_summary %>% 
  ggplot(aes(x = metric,
         y = response,
         fill = int_race_gender)) +
  facet_wrap(~ interruption_style) +
  geom_bar(stat = "identity",
           position = position_dodge(0.9)) +
  geom_errorbar(aes(ymin = lower_bound,
                    ymax = upper_bound),
                width = 0.25,
                position = position_dodge(0.9))
error_bars_plot
```

```{r brms models}
#simpler ones
PEM_model_race <- brm(PEM_interruptor ~ int_race + 
                    (1 | workerid) +
                    (1 | A_face) +
                    (1 | A_name))
summary(PEM_model_race)

PEM_model_gender <- brm(PEM_interruptor ~ int_sex + 
                    (1 | workerid) +
                    (1 | A_face) +
                    (1 | A_name))
summary(PEM_model_gender)

IM_model_race <- brm(IM ~ int_race + 
                    (1 | workerid) +
                    (1 | A_face) +
                    (1 | A_name))
summary(IM_model_race)

IM_model_gender <- brm(IM ~ int_sex + 
                    (1 | workerid) +
                    (1 | A_face) +
                    (1 | A_name))
summary(IM_model_gender)

#looking at interactions
model_int <- brm(PEM_interruptor ~ int_race * int_sex
                    (1 | workerid) +
                    (1 | A_face) +
                    (1 | A_name))


```



